{% extends "base.html" %}

{% block title %}Settings - Transcribe Local{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">Settings</h1>

    <form id="settings-form" class="bg-white rounded-lg shadow p-6 space-y-6">
        <!-- Transcription Mode -->
        <div>
            <h2 class="text-lg font-semibold mb-4">Transcription Settings</h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Default Mode</label>
                    <select name="transcription_mode" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="hybrid" {% if settings.transcription_mode == 'hybrid' %}selected{% endif %}>
                            Hybrid (Recommended) - OpenAI transcription + Local diarization
                        </option>
                        <option value="openai" {% if settings.transcription_mode == 'openai' %}selected{% endif %}>
                            OpenAI Only - Fast, no speaker diarization
                        </option>
                        <option value="local" {% if settings.transcription_mode == 'local' %}selected{% endif %}>
                            Fully Local - Slower, no API costs
                        </option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">
                        Hybrid mode uses OpenAI for fast transcription and local pyannote for speaker identification.
                    </p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">OpenAI Model</label>
                    <select name="openai_model" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="whisper-1" {% if settings.openai_model == 'whisper-1' %}selected{% endif %}>whisper-1</option>
                        <option value="gpt-4o-transcribe" {% if settings.openai_model == 'gpt-4o-transcribe' %}selected{% endif %}>gpt-4o-transcribe</option>
                        <option value="gpt-4o-mini-transcribe" {% if settings.openai_model == 'gpt-4o-mini-transcribe' %}selected{% endif %}>gpt-4o-mini-transcribe</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Local Model</label>
                    <select name="local_model" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="large-v3" {% if settings.local_model == 'large-v3' %}selected{% endif %}>large-v3 (Best quality)</option>
                        <option value="large-v2" {% if settings.local_model == 'large-v2' %}selected{% endif %}>large-v2</option>
                        <option value="medium" {% if settings.local_model == 'medium' %}selected{% endif %}>medium (Faster)</option>
                        <option value="small" {% if settings.local_model == 'small' %}selected{% endif %}>small (Fastest)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Default Language</label>
                    <select name="default_language" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="" {% if not settings.default_language %}selected{% endif %}>Auto-detect</option>
                        <option value="en" {% if settings.default_language == 'en' %}selected{% endif %}>English</option>
                        <option value="ru" {% if settings.default_language == 'ru' %}selected{% endif %}>Russian</option>
                        <option value="es" {% if settings.default_language == 'es' %}selected{% endif %}>Spanish</option>
                        <option value="fr" {% if settings.default_language == 'fr' %}selected{% endif %}>French</option>
                        <option value="de" {% if settings.default_language == 'de' %}selected{% endif %}>German</option>
                        <option value="zh" {% if settings.default_language == 'zh' %}selected{% endif %}>Chinese</option>
                        <option value="ja" {% if settings.default_language == 'ja' %}selected{% endif %}>Japanese</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Uploader Server URL</label>
                    <input
                        name="server_url"
                        type="url"
                        value="{{ settings.server_url }}"
                        placeholder="http://127.0.0.1:8000"
                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                    <p class="text-xs text-gray-500 mt-1">
                        Used by <code>transcribe-local upload start</code> and remote recorder clients.
                    </p>
                </div>
            </div>
        </div>

        <!-- Environment Info -->
        <div class="border-t pt-6">
            <h2 class="text-lg font-semibold mb-4">Environment</h2>
            <div class="bg-gray-50 rounded-md p-4 text-sm font-mono">
                <div class="flex justify-between py-1">
                    <span class="text-gray-500">Database:</span>
                    <span>{{ settings.db_path }}</span>
                </div>
                <div class="flex justify-between py-1">
                    <span class="text-gray-500">Uploads:</span>
                    <span>{{ settings.upload_dir }}</span>
                </div>
                <div class="flex justify-between py-1">
                    <span class="text-gray-500">Config:</span>
                    <span>{{ settings.config_path }}</span>
                </div>
                <div class="flex justify-between py-1">
                    <span class="text-gray-500">Server URL:</span>
                    <span>{{ settings.server_url }}</span>
                </div>
            </div>
        </div>

        <!-- API Keys Notice -->
        <div class="border-t pt-6">
            <h2 class="text-lg font-semibold mb-4">API Keys</h2>
            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 text-sm">
                <p class="text-yellow-800">
                    API keys are configured via environment variables:
                </p>
                <ul class="mt-2 text-yellow-700 list-disc list-inside">
                    <li><code>OPENAI_API_KEY</code> - Required for OpenAI/Hybrid modes</li>
                    <li><code>HF_TOKEN</code> - Required for local diarization (pyannote)</li>
                </ul>
            </div>
        </div>

        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
            Save Settings
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('settings-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
            const response = await fetch('/api/settings', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                alert('Settings saved!');
            } else {
                alert('Error: ' + (data.detail || 'Failed to save settings'));
            }
        } catch (err) {
            alert('Error: ' + err.message);
        }
    });
</script>
{% endblock %}
